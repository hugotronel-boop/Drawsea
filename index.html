<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Melodia</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap');

:root {
‚Äìbg: #0a0a0f;
‚Äìsurface: #12121a;
‚Äìsurface2: #1a1a26;
‚Äìaccent: #ff3c6e;
‚Äìaccent2: #00e5ff;
‚Äìaccent3: #ffe066;
‚Äìtext: #f0f0f8;
‚Äìmuted: #555577;
‚Äìgrid: #1e1e2e;
}

- { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
background: var(‚Äìbg);
color: var(‚Äìtext);
font-family: ‚ÄòSyne‚Äô, sans-serif;
min-height: 100vh;
display: flex;
flex-direction: column;
overflow: hidden;
height: 100dvh;
}

/* HEADER */
header {
display: flex;
align-items: center;
justify-content: space-between;
padding: 14px 20px;
border-bottom: 1px solid #1e1e30;
background: var(‚Äìsurface);
flex-shrink: 0;
}

.logo {
font-size: 22px;
font-weight: 800;
letter-spacing: -1px;
background: linear-gradient(90deg, var(‚Äìaccent), var(‚Äìaccent2));
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
}

.status-pill {
font-family: ‚ÄòSpace Mono‚Äô, monospace;
font-size: 10px;
padding: 4px 10px;
border-radius: 20px;
border: 1px solid var(‚Äìmuted);
color: var(‚Äìmuted);
transition: all .3s;
}

.status-pill.recording {
border-color: var(‚Äìaccent);
color: var(‚Äìaccent);
animation: pulse 1s infinite;
}

@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.5; }
}

/* PIANO ROLL AREA */
.piano-roll-wrap {
flex: 1;
overflow: hidden;
position: relative;
display: flex;
flex-direction: column;
}

/* Note labels + grid */
.roll-container {
display: flex;
flex: 1;
overflow: hidden;
}

.note-labels {
width: 42px;
flex-shrink: 0;
overflow: hidden;
background: var(‚Äìsurface);
border-right: 1px solid #1e1e30;
}

.note-label {
height: 24px;
display: flex;
align-items: center;
justify-content: flex-end;
padding-right: 6px;
font-family: ‚ÄòSpace Mono‚Äô, monospace;
font-size: 9px;
color: var(‚Äìmuted);
border-bottom: 1px solid #1a1a24;
cursor: pointer;
transition: color .2s;
}

.note-label.black-key {
background: #0f0f18;
color: #444466;
}

.note-label:hover, .note-label.active {
color: var(‚Äìaccent2);
}

.grid-scroll {
flex: 1;
overflow-x: auto;
overflow-y: hidden;
position: relative;
scroll-behavior: smooth;
}

canvas#pianoRoll {
display: block;
cursor: pointer;
}

/* Playhead */
.playhead {
position: absolute;
top: 0;
width: 2px;
background: var(‚Äìaccent);
pointer-events: none;
box-shadow: 0 0 8px var(‚Äìaccent);
transition: left .05s linear;
display: none;
}

/* BOTTOM CONTROLS */
.controls {
background: var(‚Äìsurface);
border-top: 1px solid #1e1e30;
padding: 16px 20px 20px;
flex-shrink: 0;
}

.controls-row {
display: flex;
gap: 10px;
align-items: center;
justify-content: center;
margin-bottom: 12px;
}

.btn {
border: none;
border-radius: 12px;
cursor: pointer;
font-family: ‚ÄòSyne‚Äô, sans-serif;
font-weight: 700;
transition: all .2s;
display: flex;
align-items: center;
gap: 6px;
-webkit-tap-highlight-color: transparent;
}

.btn-record {
background: var(‚Äìaccent);
color: white;
padding: 14px 28px;
font-size: 15px;
border-radius: 50px;
box-shadow: 0 0 20px rgba(255,60,110,0.3);
flex: 1;
justify-content: center;
max-width: 200px;
}

.btn-record:active { transform: scale(0.96); }
.btn-record.recording {
background: #ff6b6b;
animation: pulseBg 1s infinite;
}

@keyframes pulseBg {
0%, 100% { box-shadow: 0 0 20px rgba(255,60,110,0.3); }
50% { box-shadow: 0 0 40px rgba(255,60,110,0.7); }
}

.btn-icon {
background: var(‚Äìsurface2);
color: var(‚Äìtext);
padding: 14px;
font-size: 18px;
border-radius: 12px;
border: 1px solid #2a2a3e;
min-width: 52px;
justify-content: center;
}

.btn-icon:active { transform: scale(0.93); }
.btn-icon.active { border-color: var(‚Äìaccent2); color: var(‚Äìaccent2); }

/* TEMPO & settings */
.settings-row {
display: flex;
align-items: center;
gap: 12px;
justify-content: center;
}

.tempo-control {
display: flex;
align-items: center;
gap: 8px;
background: var(‚Äìsurface2);
border-radius: 10px;
padding: 6px 12px;
border: 1px solid #2a2a3e;
}

.tempo-label {
font-family: ‚ÄòSpace Mono‚Äô, monospace;
font-size: 10px;
color: var(‚Äìmuted);
}

.tempo-val {
font-family: ‚ÄòSpace Mono‚Äô, monospace;
font-size: 13px;
color: var(‚Äìaccent3);
min-width: 32px;
text-align: center;
}

.tempo-btn {
background: none;
border: none;
color: var(‚Äìmuted);
font-size: 16px;
cursor: pointer;
padding: 2px 4px;
transition: color .2s;
}

.tempo-btn:active { color: var(‚Äìaccent3); }

/* waveform viz */
.waveform-bar {
height: 36px;
background: var(‚Äìsurface2);
border-radius: 8px;
overflow: hidden;
margin-bottom: 12px;
border: 1px solid #1e1e30;
position: relative;
}

canvas#waveform {
width: 100%;
height: 100%;
}

/* Sensitivity */
.sens-row {
display: flex;
align-items: center;
gap: 8px;
}

.sens-label {
font-family: ‚ÄòSpace Mono‚Äô, monospace;
font-size: 10px;
color: var(‚Äìmuted);
white-space: nowrap;
}

input[type=range] {
flex: 1;
accent-color: var(‚Äìaccent2);
height: 4px;
}

/* Toast */
.toast {
position: fixed;
top: 70px;
left: 50%;
transform: translateX(-50%) translateY(-20px);
background: var(‚Äìsurface2);
border: 1px solid var(‚Äìaccent2);
color: var(‚Äìaccent2);
font-family: ‚ÄòSpace Mono‚Äô, monospace;
font-size: 11px;
padding: 8px 16px;
border-radius: 20px;
opacity: 0;
transition: all .3s;
pointer-events: none;
z-index: 100;
white-space: nowrap;
}

.toast.show {
opacity: 1;
transform: translateX(-50%) translateY(0);
}

/* Empty state */
.empty-hint {
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%,-50%);
text-align: center;
color: var(‚Äìmuted);
pointer-events: none;
}

.empty-hint .icon { font-size: 36px; margin-bottom: 8px; }
.empty-hint p { font-size: 13px; line-height: 1.6; }

/* Edit mode overlay */
.edit-hint {
position: absolute;
bottom: 8px;
right: 10px;
font-family: ‚ÄòSpace Mono‚Äô, monospace;
font-size: 9px;
color: var(‚Äìmuted);
pointer-events: none;
}
</style>

</head>
<body>

<header>
  <div class="logo">üéµ Melodia</div>
  <div class="status-pill" id="statusPill">PR√äT</div>
</header>

<div class="piano-roll-wrap">
  <div class="waveform-bar">
    <canvas id="waveform"></canvas>
  </div>
  <div class="roll-container">
    <div class="note-labels" id="noteLabels"></div>
    <div class="grid-scroll" id="gridScroll">
      <canvas id="pianoRoll"></canvas>
      <div class="playhead" id="playhead"></div>
      <div class="empty-hint" id="emptyHint">
        <div class="icon">üé§</div>
        <p>Chante ou siffle une m√©lodie<br>puis appuie sur <strong>ENREGISTRER</strong></p>
      </div>
      <div class="edit-hint" id="editHint" style="display:none">Tap pour ajouter ‚Ä¢ Drag pour d√©placer</div>
    </div>
  </div>
</div>

<div class="controls">
  <div class="controls-row">
    <button class="btn btn-icon" id="btnPlay" title="Rejouer">‚ñ∂</button>
    <button class="btn btn-record" id="btnRecord">üé§ ENREGISTRER</button>
    <button class="btn btn-icon" id="btnClear" title="Effacer">üóë</button>
    <button class="btn btn-icon" id="btnEdit" title="Mode √©dition">‚úèÔ∏è</button>
  </div>
  <div class="settings-row">
    <div class="tempo-control">
      <button class="tempo-btn" id="btnTempoDec">‚àí</button>
      <span class="tempo-label">BPM</span>
      <span class="tempo-val" id="tempoVal">120</span>
      <button class="tempo-btn" id="btnTempoInc">+</button>
    </div>
    <div class="sens-row">
      <span class="sens-label">SENS</span>
      <input type="range" id="sensitivity" min="1" max="5" value="3" step="1">
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ NOTES CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const NOTES = [];
const noteNames = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const isBlack = n => n.includes('#');

// Build C2 ‚Üí C7 (5 octaves)
for (let oct = 6; oct >= 2; oct--) {
  for (let i = 11; i >= 0; i--) {
    NOTES.push({ name: noteNames[i] + oct, freq: 440 * Math.pow(2, (i + (oct - 4) * 12 - 9) / 12), black: isBlack(noteNames[i]) });
  }
}

const NOTE_H = 22;
const CELL_W = 40;
const HEADER_H = 20;
let bpm = 120;
let notes = []; // {noteIdx, startBeat, duration, id}
let nextId = 0;
let totalBeats = 16;
let editMode = false;
let isRecording = false;
let isPlaying = false;

// AudioContext
let audioCtx = null;
const getAC = () => {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
};

// ‚îÄ‚îÄ‚îÄ BUILD NOTE LABELS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const labelsEl = document.getElementById('noteLabels');
labelsEl.style.height = (NOTES.length * NOTE_H) + 'px';
NOTES.forEach((n, i) => {
  const d = document.createElement('div');
  d.className = 'note-label' + (n.black ? ' black-key' : '');
  d.style.height = NOTE_H + 'px';
  d.dataset.idx = i;
  d.textContent = n.name;
  d.addEventListener('click', () => previewNote(i));
  labelsEl.appendChild(d);
});

// ‚îÄ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas = document.getElementById('pianoRoll');
const ctx2d = canvas.getContext('2d');

function resizeCanvas() {
  const scroll = document.getElementById('gridScroll');
  const w = Math.max(totalBeats * CELL_W + CELL_W, scroll.clientWidth);
  canvas.width = w;
  canvas.height = NOTES.length * NOTE_H + HEADER_H;
  canvas.style.height = canvas.height + 'px';
  draw();
}

function draw() {
  const W = canvas.width, H = canvas.height;
  ctx2d.clearRect(0, 0, W, H);

  // Background rows
  NOTES.forEach((n, i) => {
    const y = HEADER_H + i * NOTE_H;
    ctx2d.fillStyle = n.black ? '#0d0d16' : '#111119';
    ctx2d.fillRect(0, y, W, NOTE_H);
    ctx2d.strokeStyle = '#1c1c2a';
    ctx2d.lineWidth = 1;
    ctx2d.beginPath();
    ctx2d.moveTo(0, y + NOTE_H);
    ctx2d.lineTo(W, y + NOTE_H);
    ctx2d.stroke();
    // C marker
    if (n.name.startsWith('C') && !n.black) {
      ctx2d.fillStyle = '#1e1e30';
      ctx2d.fillRect(0, y, W, 1);
    }
  });

  // Beat grid
  for (let b = 0; b <= totalBeats; b++) {
    const x = b * CELL_W;
    ctx2d.strokeStyle = b % 4 === 0 ? '#2a2a40' : '#1a1a28';
    ctx2d.lineWidth = b % 4 === 0 ? 1.5 : 1;
    ctx2d.beginPath();
    ctx2d.moveTo(x, 0);
    ctx2d.lineTo(x, H);
    ctx2d.stroke();
    // Beat numbers
    if (b > 0 && b % 4 === 0) {
      ctx2d.fillStyle = '#333355';
      ctx2d.font = '10px Space Mono, monospace';
      ctx2d.fillText(b, x + 3, 14);
    }
  }

  // Draw notes
  notes.forEach(note => {
    const x = note.startBeat * CELL_W;
    const y = HEADER_H + note.noteIdx * NOTE_H + 2;
    const w = note.duration * CELL_W - 2;
    const h = NOTE_H - 4;
    const color = getNoteColor(note.noteIdx);

    // Shadow glow
    ctx2d.shadowColor = color;
    ctx2d.shadowBlur = 8;
    ctx2d.fillStyle = color;
    const r = 5;
    ctx2d.beginPath();
    ctx2d.roundRect(x, y, w, h, r);
    ctx2d.fill();
    ctx2d.shadowBlur = 0;

    // Lighter top
    ctx2d.fillStyle = 'rgba(255,255,255,0.15)';
    ctx2d.beginPath();
    ctx2d.roundRect(x, y, w, h / 2, [r, r, 0, 0]);
    ctx2d.fill();

    // Note name
    if (w > 24) {
      ctx2d.fillStyle = 'rgba(0,0,0,0.7)';
      ctx2d.font = '8px Space Mono, monospace';
      ctx2d.fillText(NOTES[note.noteIdx].name, x + 4, y + h - 4);
    }
  });
}

function getNoteColor(idx) {
  const hue = (idx * 17 + 200) % 360;
  return `hsl(${hue},80%,55%)`;
}

// ‚îÄ‚îÄ‚îÄ WAVEFORM CANVAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const wCanvas = document.getElementById('waveform');
const wCtx = wCanvas.getContext('2d');
let waveAnimId = null;
let analyserNode = null;

function startWaveform(analyser) {
  analyserNode = analyser;
  const buf = new Uint8Array(analyser.fftSize);
  function draw() {
    waveAnimId = requestAnimationFrame(draw);
    analyser.getByteTimeDomainData(buf);
    wCtx.clearRect(0, 0, wCanvas.width, wCanvas.height);
    wCtx.strokeStyle = '#ff3c6e';
    wCtx.lineWidth = 1.5;
    wCtx.beginPath();
    const sl = wCanvas.width / buf.length;
    buf.forEach((v, i) => {
      const x = i * sl;
      const y = (v / 255) * wCanvas.height;
      i === 0 ? wCtx.moveTo(x, y) : wCtx.lineTo(x, y);
    });
    wCtx.stroke();
  }
  draw();
}

function stopWaveform() {
  if (waveAnimId) cancelAnimationFrame(waveAnimId);
  wCtx.clearRect(0, 0, wCanvas.width, wCanvas.height);
}

function resizeWave() {
  wCanvas.width = wCanvas.offsetWidth;
  wCanvas.height = wCanvas.offsetHeight;
}

// ‚îÄ‚îÄ‚îÄ PITCH DETECTION (autocorrelation) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function autoCorrelate(buf, sampleRate) {
  let SIZE = buf.length;
  let rms = 0;
  for (let i = 0; i < SIZE; i++) rms += buf[i] * buf[i];
  rms = Math.sqrt(rms / SIZE);
  if (rms < 0.01) return -1;

  let r1 = 0, r2 = SIZE - 1;
  const thres = 0.2;
  for (let i = 0; i < SIZE / 2; i++) { if (Math.abs(buf[i]) < thres) { r1 = i; break; } }
  for (let i = 1; i < SIZE / 2; i++) { if (Math.abs(buf[SIZE - i]) < thres) { r2 = SIZE - i; break; } }
  buf = buf.slice(r1, r2);
  SIZE = buf.length;

  const c = new Float32Array(SIZE).fill(0);
  for (let i = 0; i < SIZE; i++)
    for (let j = 0; j < SIZE - i; j++)
      c[i] += buf[j] * buf[j + i];

  let d = 0;
  while (c[d] > c[d + 1]) d++;
  let maxVal = -1, maxPos = -1;
  for (let i = d; i < SIZE; i++) { if (c[i] > maxVal) { maxVal = c[i]; maxPos = i; } }
  let T0 = maxPos;
  const x1 = c[T0 - 1], x2 = c[T0], x3 = c[T0 + 1];
  const a = (x1 + x3 - 2 * x2) / 2, b2 = (x3 - x1) / 2;
  if (a) T0 = T0 - b2 / (2 * a);
  return sampleRate / T0;
}

function freqToNoteIdx(freq) {
  if (freq <= 0) return -1;
  const lowestFreq = NOTES[NOTES.length - 1].freq;
  const highestFreq = NOTES[0].freq;
  if (freq < lowestFreq || freq > highestFreq) return -1;
  let best = -1, bestDist = Infinity;
  NOTES.forEach((n, i) => {
    const d = Math.abs(Math.log2(freq / n.freq));
    if (d < bestDist) { bestDist = d; best = i; }
  });
  return bestDist < 0.1 ? best : -1;
}

// ‚îÄ‚îÄ‚îÄ RECORDING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let mediaStream = null;
let sourceNode = null;
let analyserForPitch = null;
let recordingInterval = null;
let lastNoteIdx = -1;
let lastNoteStart = 0;
let currentBeat = 0;

const BEAT_MS = () => (60000 / bpm);
const sensEl = document.getElementById('sensitivity');

async function startRecording() {
  try {
    const ac = getAC();
    if (ac.state === 'suspended') await ac.resume();
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    sourceNode = ac.createMediaStreamSource(mediaStream);
    analyserForPitch = ac.createAnalyser();
    analyserForPitch.fftSize = 2048;
    sourceNode.connect(analyserForPitch);
    startWaveform(analyserForPitch);

    notes = [];
    currentBeat = 0;
    lastNoteIdx = -1;
    totalBeats = 16;
    isRecording = true;
    updateUI();
    resizeCanvas();

    const buf = new Float32Array(analyserForPitch.fftSize);
    const beatMs = BEAT_MS();
    const tickMs = beatMs / 4; // 16th note resolution
    let tickCount = 0;
    const minSens = 7 - parseInt(sensEl.value); // higher sens = lower min

    recordingInterval = setInterval(() => {
      analyserForPitch.getFloatTimeDomainData(buf);
      const freq = autoCorrelate(buf, ac.sampleRate);
      const noteIdx = freqToNoteIdx(freq);
      const beat = tickCount * 0.25;

      if (noteIdx !== -1) {
        if (noteIdx !== lastNoteIdx) {
          // Finalize previous
          if (lastNoteIdx !== -1) finalizeNote(lastNoteIdx, lastNoteStart, beat);
          lastNoteIdx = noteIdx;
          lastNoteStart = beat;
        }
      } else {
        if (lastNoteIdx !== -1) {
          finalizeNote(lastNoteIdx, lastNoteStart, beat);
          lastNoteIdx = -1;
        }
      }

      tickCount++;
      currentBeat = beat;
      if (beat > totalBeats - 2) {
        totalBeats += 8;
        resizeCanvas();
      } else {
        draw();
      }
    }, tickMs);

  } catch (e) {
    showToast('‚ùå Microphone refus√©');
    isRecording = false;
    updateUI();
  }
}

function finalizeNote(noteIdx, start, end) {
  const dur = Math.max(0.25, Math.round((end - start) * 4) / 4);
  notes.push({ noteIdx, startBeat: Math.round(start * 4) / 4, duration: dur, id: nextId++ });
  draw();
}

function stopRecording() {
  isRecording = false;
  clearInterval(recordingInterval);
  if (lastNoteIdx !== -1) {
    finalizeNote(lastNoteIdx, lastNoteStart, currentBeat);
    lastNoteIdx = -1;
  }
  stopWaveform();
  if (mediaStream) { mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; }
  if (sourceNode) { sourceNode.disconnect(); sourceNode = null; }
  updateUI();
  if (notes.length === 0) showToast('üò∂ Aucune note d√©tect√©e ‚Äî essaie encore !');
  else showToast(`‚úÖ ${notes.length} notes captur√©es !`);
  document.getElementById('emptyHint').style.display = 'none';
}

// ‚îÄ‚îÄ‚îÄ PLAYBACK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let playbackTimeout = null;
let playAnimId = null;
let playStartTime = 0;

function playNotes() {
  if (notes.length === 0) { showToast('üéµ Rien √† jouer !'); return; }
  stopPlayback();
  const ac = getAC();
  if (ac.state === 'suspended') ac.resume();
  isPlaying = true;
  updateUI();

  const beatSec = 60 / bpm;
  const maxEnd = Math.max(...notes.map(n => n.startBeat + n.duration));

  notes.forEach(note => {
    const start = note.startBeat * beatSec;
    const dur = note.duration * beatSec;
    const freq = NOTES[note.noteIdx].freq;
    const t = ac.currentTime + start + 0.05;

    const osc = ac.createOscillator();
    const gain = ac.createGain();
    osc.connect(gain);
    gain.connect(ac.destination);

    osc.type = 'sine';
    osc.frequency.setValueAtTime(freq, t);

    // Piano-like envelope
    gain.gain.setValueAtTime(0, t);
    gain.gain.linearRampToValueAtTime(0.4, t + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.1, t + dur * 0.7);
    gain.gain.exponentialRampToValueAtTime(0.001, t + dur);

    // Add harmonics for richer sound
    const osc2 = ac.createOscillator();
    const gain2 = ac.createGain();
    osc2.connect(gain2);
    gain2.connect(ac.destination);
    osc2.type = 'sine';
    osc2.frequency.setValueAtTime(freq * 2, t);
    gain2.gain.setValueAtTime(0, t);
    gain2.gain.linearRampToValueAtTime(0.1, t + 0.01);
    gain2.gain.exponentialRampToValueAtTime(0.001, t + dur * 0.5);

    osc.start(t); osc.stop(t + dur + 0.1);
    osc2.start(t); osc2.stop(t + dur);
  });

  // Playhead animation
  playStartTime = performance.now();
  const totalDur = maxEnd * beatSec * 1000;
  const ph = document.getElementById('playhead');
  ph.style.display = 'block';
  ph.style.height = canvas.height + 'px';

  function animPH() {
    const elapsed = performance.now() - playStartTime;
    const beat = (elapsed / 1000) / beatSec;
    ph.style.left = (beat * CELL_W) + 'px';
    if (elapsed < totalDur + 200) playAnimId = requestAnimationFrame(animPH);
    else stopPlayback();
  }
  animPH();
}

function stopPlayback() {
  isPlaying = false;
  updateUI();
  if (playAnimId) cancelAnimationFrame(playAnimId);
  document.getElementById('playhead').style.display = 'none';
}

// ‚îÄ‚îÄ‚îÄ EDIT MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
canvas.addEventListener('click', (e) => {
  if (!editMode) return;
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  const cx = (e.clientX - rect.left) * scaleX;
  const cy = (e.clientY - rect.top) * scaleY;

  const beat = Math.floor(cx / CELL_W);
  const noteIdx = Math.floor((cy - HEADER_H) / NOTE_H);
  if (noteIdx < 0 || noteIdx >= NOTES.length) return;

  // Check if clicking existing note (delete)
  const existing = notes.find(n =>
    n.noteIdx === noteIdx &&
    beat >= n.startBeat &&
    beat < n.startBeat + n.duration
  );

  if (existing) {
    notes = notes.filter(n => n.id !== existing.id);
    showToast('üóë Note supprim√©e');
  } else {
    notes.push({ noteIdx, startBeat: beat, duration: 1, id: nextId++ });
    previewNote(noteIdx);
  }
  draw();
});

// Touch scroll sync labels
const gridScroll = document.getElementById('gridScroll');
// Note: vertical scroll not needed since we show all notes

// ‚îÄ‚îÄ‚îÄ PREVIEW NOTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function previewNote(idx) {
  const ac = getAC();
  if (ac.state === 'suspended') ac.resume();
  const osc = ac.createOscillator();
  const gain = ac.createGain();
  osc.connect(gain);
  gain.connect(ac.destination);
  osc.type = 'sine';
  osc.frequency.value = NOTES[idx].freq;
  gain.gain.setValueAtTime(0.3, ac.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.4);
  osc.start();
  osc.stop(ac.currentTime + 0.4);
}

// ‚îÄ‚îÄ‚îÄ UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const btnRecord = document.getElementById('btnRecord');
const btnPlay = document.getElementById('btnPlay');
const btnClear = document.getElementById('btnClear');
const btnEdit = document.getElementById('btnEdit');
const statusPill = document.getElementById('statusPill');

btnRecord.addEventListener('click', () => {
  if (isRecording) stopRecording();
  else startRecording();
});

btnPlay.addEventListener('click', () => {
  if (isPlaying) stopPlayback();
  else playNotes();
});

btnClear.addEventListener('click', () => {
  stopPlayback();
  notes = [];
  totalBeats = 16;
  resizeCanvas();
  document.getElementById('emptyHint').style.display = '';
  showToast('üóë M√©lodie effac√©e');
});

btnEdit.addEventListener('click', () => {
  editMode = !editMode;
  btnEdit.classList.toggle('active', editMode);
  document.getElementById('editHint').style.display = editMode ? '' : 'none';
  showToast(editMode ? '‚úèÔ∏è Mode √©dition ‚Äî Tap pour ajouter/supprimer' : '‚úèÔ∏è Mode √©dition d√©sactiv√©');
});

document.getElementById('btnTempoDec').addEventListener('click', () => {
  bpm = Math.max(60, bpm - 5);
  document.getElementById('tempoVal').textContent = bpm;
});

document.getElementById('btnTempoInc').addEventListener('click', () => {
  bpm = Math.min(200, bpm + 5);
  document.getElementById('tempoVal').textContent = bpm;
});

function updateUI() {
  btnRecord.textContent = isRecording ? '‚èπ STOP' : 'üé§ ENREGISTRER';
  btnRecord.classList.toggle('recording', isRecording);
  statusPill.textContent = isRecording ? 'REC' : isPlaying ? 'PLAY' : 'PR√äT';
  statusPill.classList.toggle('recording', isRecording);
  btnPlay.textContent = isPlaying ? '‚èπ' : '‚ñ∂';
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('resize', () => { resizeCanvas(); resizeWave(); });
resizeWave();
resizeCanvas();
</script>

</body>
</html>

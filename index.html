<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voix â†’ MÃ©lodie</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<h1>ðŸŽ¤ Chante ta mÃ©lodie !</h1>
<canvas id="canvas"></canvas>
<button id="playBtn">â–¶ Jouer la mÃ©lodie</button>

<script src="https://cdn.jsdelivr.net/npm/tone@14.8.39/build/Tone.js"></script>
<script src="script.js"></script>
</body>
</html><style>html, body {
  margin: 0;
  padding: 0;
  background: #111;
  color: white;
  font-family: sans-serif;
  text-align: center;
}

h1 {
  margin: 10px;
}

canvas {
  display: block;
  margin: 0 auto;
  background: #222;
  width: 100%;
  height: 200px;
}

button {
  margin: 10px;
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
}</style><script>const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = 200;

window.addEventListener("resize", ()=>{
  canvas.width = window.innerWidth;
});

// ===============================
// UTILS : freq â†’ note
// ===============================
function frequencyToNote(f) {
  const A4 = 440;
  const notes = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const semitone = Math.round(12 * Math.log2(f / A4));
  const noteIndex = (semitone + 9 + 120) % 12;
  const octave = 4 + Math.floor((semitone + 9) / 12);
  return notes[noteIndex] + octave;
}

// ===============================
// SETUP AUDIO
// ===============================
navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
  const audioCtx = new AudioContext();
  const source = audioCtx.createMediaStreamSource(stream);
  const analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  source.connect(analyser);

  const buffer = new Float32Array(analyser.fftSize);
  let notesDetected = [];
  let lastNote = null;

  function autoCorrelate(buf, sampleRate) {
    let SIZE = buf.length;
    let rms = 0;
    for (let i=0;i<SIZE;i++) rms += buf[i]*buf[i];
    rms = Math.sqrt(rms/SIZE);
    if(rms < 0.01) return -1;

    let r = [];
    for (let k=0;k<SIZE/2;k++){
      let sum = 0;
      for(let i=0;i<SIZE/2;i++) sum += buf[i]*buf[i+k];
      r[k] = sum;
    }
    let d=0; while(r[d]>r[d+1]) d++;
    let maxval=-1, maxpos=-1;
    for(let i=d;i<SIZE/2;i++){ if(r[i]>maxval){maxval=r[i]; maxpos=i;} }
    let T0 = maxpos;
    return sampleRate / T0;
  }

  function detectPitch() {
    analyser.getFloatTimeDomainData(buffer);
    let freq = autoCorrelate(buffer, audioCtx.sampleRate);
    if(freq>50 && freq<2000){
      let note = frequencyToNote(freq);
      // ajouter seulement si note change
      if(note !== lastNote){
        notesDetected.push(note);
        lastNote = note;
        drawNotes();
      }
    } else {
      lastNote = null;
    }
    requestAnimationFrame(detectPitch);
  }

  detectPitch();

  // ===============================
  // DESSIN
  // ===============================
  function drawNotes(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "white";
    ctx.font = "20px sans-serif";

    for(let i=0;i<notesDetected.length;i++){
      ctx.fillText(notesDetected[i], 20+i*60, canvas.height/2);
      ctx.beginPath();
      ctx.arc(20+i*60, canvas.height/2+25, 10, 0, Math.PI*2);
      ctx.fill();
    }
  }

  // ===============================
  // PLAY BUTTON
  // ===============================
  const synth = new Tone.Synth().toDestination();
  const playBtn = document.getElementById("playBtn");
  playBtn.addEventListener("click", async ()=>{
    await Tone.start();
    let now = Tone.now();
    notesDetected.forEach((note,i)=>{
      synth.triggerAttackRelease(note,"8n", now + i*0.5);
    });
  });
});</script>
